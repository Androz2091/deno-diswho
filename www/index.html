<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="utf-8">
		<title>DisWho</title>
		<style>
			body {
				font-family: sans-serif;
				font-size: 2.5rem;
				margin: 0;
				padding: 0;
				width: 100vw;
				height: 100vh;
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				text-align: center;
				color: #ABB2BF;
				background-color: #282C34;
			}
		</style>
		<script>
			window.addEventListener('DOMContentLoaded', async () => {
				const
					message = document.querySelector('.message'),
					button = document.createElement('button'),
					script = document.createElement('script'),
					{ publicKey } = await (await fetch('/captcha/credentials')).json();
				button.classList.add('g-recaptcha');
				button.setAttribute('data-sitekey', publicKey);
				button.setAttribute('data-action', 'submit');
				script.setAttribute('src', `https://www.google.com/recaptcha/api.js?render=${publicKey}`);
				script.addEventListener('load', async () => grecaptcha.ready(async () => {
					button.addEventListener('click', async () => {
						document.body.removeChild(button);
						message.textContent = 'Generating captcha';
						const token = await grecaptcha.execute(publicKey);
						message.textContent = 'Validating captcha';
						const {
							success,
							jwt
						} = await (await fetch(`/captcha/validate?token=${token}`)).json();
						if(success){
							message.textContent = 'Captcha validated';
						}
						else
							message.textContent = 'Captcha failed';
					});
					document.body.appendChild(button);
					button.click();
				}));
				document.body.appendChild(script);
			});
		</script>
	</head>
	<body>
		<p class="message">Loading</p>
	</body>
</html>